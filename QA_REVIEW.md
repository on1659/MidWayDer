# MidWayDer QA 검토 보고서

**작성자**: [QA] Tester
**작성일**: 2026-01-29
**버전**: 1.0.0

---

## 개요

이 문서는 MidWayDer 프로젝트의 기획안을 검토하고, 발생 가능한 **데이터 오차**, **지도 데이터 한계점**, **예외 케이스**를 분석한 QA 보고서입니다.

---

## 1. 데이터 정확도 및 예상 오차 범위

### 1.1 거리 정확도

| 측정 항목 | 데이터 소스 | 예상 오차 | 원인 |
|----------|-----------|----------|------|
| **A→B 원본 경로 거리** | Naver Directions API | ±5% | 도로 폭, 차선 변경 등 미세 차이 |
| **Detour Cost 거리** | Naver Directions API | ±5% | 동일 API 사용, 일관된 오차 |
| **Haversine 거리 (샘플링용)** | 자체 계산 | ±0.3% | 지구를 완전한 구로 가정한 이론값 |
| **PostGIS ST_Distance** | PostGIS 계산 | ±0.1% | 정밀한 지리 계산 |

**결론**:
- Naver Directions API의 ±5% 오차는 **허용 가능 범위**입니다.
- 사용자에게 "약 12.5km" 형식으로 표시하여 정밀도 기대감을 낮춥니다.

### 1.2 시간 정확도

| 측정 항목 | 데이터 소스 | 예상 오차 | 원인 |
|----------|-----------|----------|------|
| **주행 시간** | Naver Directions API | ±10% | 실시간 교통 반영, 신호대기 제외 |
| **실제 소요 시간** | 사용자 체감 | ±20% | 신호대기, 주차, 매장 체류 시간 미포함 |

**주요 미반영 요소**:
1. ❌ **신호 대기 시간**: Naver API는 신호 정보 미포함
2. ❌ **주차 시간**: 매장 진입 후 주차장 찾기, 주차 소요
3. ❌ **매장 체류 시간**: 물건 구매, 계산 대기 시간
4. ❌ **날씨/사고**: 돌발 상황 실시간 반영 제한

**대응 방안**:
- UI에 명확한 안내 문구 표시:
  ```
  ⚠️ 표시된 시간은 주행 시간만 포함됩니다.
  신호대기, 주차, 매장 체류 시간은 별도로 소요됩니다.
  ```

### 1.3 매장 위치 정확도

| 측정 항목 | 데이터 소스 | 예상 오차 | 원인 |
|----------|-----------|----------|------|
| **매장 좌표** | Naver Local Search API | ±10m | 건물 중심 vs 출입구 위치 차이 |
| **매장 주소** | Naver Local Search API | 실시간 반영 지연 | 최대 24시간 지연 가능 |

**주요 위험 시나리오**:
1. 🏢 **대형 건물**: 매장이 건물 후면에 있지만 좌표는 정문 기준
2. 🚪 **지하 매장**: 지상 출입구와 매장 위치 불일치
3. 🏗️ **신규 개점**: Naver 데이터 갱신 전 검색 불가
4. ❌ **폐업 매장**: 임시 휴업, 폐업 정보 지연

**대응 방안**:
- 매장 정보 하단에 "영업 여부를 매장에 확인해주세요" 안내
- 주기적 매장 데이터 갱신 (주 1회 권장)

---

## 2. 지도 데이터 한계점

### 2.1 실제 도로 상황 예외 케이스

#### 2.1.1 중앙분리대 (유턴 필요)

**상황**:
- 직선거리는 매우 가깝지만 (50m), 중앙분리대로 인해 유턴 필요
- 실제 이동 거리: 500m 이상

**예시**:
- 강남대로의 반대편 매장
- 한강대교 상의 매장 (반대 차선)

**해결 방안**:
- ✅ Naver Directions API가 **자동으로 유턴 경로 반영**
- ✅ 실제 도로 거리로 정확히 계산됨

**검증 필요**:
- [ ] 강남대로 중앙분리대 구간 테스트
- [ ] 유턴 금지 구역 테스트 (경로 없음 예상)

---

#### 2.1.2 일방통행

**상황**:
- A→C는 진입 가능하지만, C→B 방향이 일방통행으로 막힘
- 큰 우회로 필요

**예시**:
- 종로구 골목길 다이소
- 명동 일방통행 구역

**해결 방안**:
- ✅ Naver Directions API가 일방통행 자동 고려
- ⚠️ C→B 경로가 없는 경우: API 404 에러 → 해당 매장 제외

**검증 필요**:
- [ ] 종로구 일방통행 구역 테스트
- [ ] 경로 없음(404) 처리 로직 확인

---

#### 2.1.3 고가도로 / 지하차도 진입로

**상황**:
- 매장이 고가도로 바로 아래에 있지만, 진입로가 1km 떨어짐
- 직선거리: 100m, 실제 거리: 1.5km

**예시**:
- 강변북로 하부 매장
- 올림픽대로 인근 매장

**해결 방안**:
- ✅ Directions API의 실제 도로 경로 사용으로 자동 해결
- ✅ 진입로 우회 거리가 Detour Cost에 정확히 반영됨

**검증 필요**:
- [ ] 강변북로 하부 매장 테스트
- [ ] 3D 입체 도로 구조 정확도 확인

---

#### 2.1.4 교차로 좌회전 제한

**상황**:
- 좌회전 금지로 인해 큰 우회 필요
- 오전/오후 시간대별 좌회전 제한 존재

**예시**:
- 주요 간선도로 교차로 (강남대로, 테헤란로)

**해결 방안**:
- ✅ Directions API가 좌회전 제한 자동 반영
- ⚠️ **시간대별 제한**은 검색 시점 기준 적용 (출발 시간 지정 불가)

**검증 필요**:
- [ ] 좌회전 금지 구역 테스트
- [ ] 시간대별 제한 정확도 확인

---

### 2.2 PostGIS 공간 쿼리 한계

#### 2.2.1 ST_DWithin 버퍼 검색

**한계점**:
- 원형 버퍼 검색이므로 **경로에서 멀어지는 수직 방향**도 포함
- 경로 길이 방향으로는 가깝지만, 수직으로 멀면 과도한 이탈 발생

**예시**:
```
A ──────────────────────> B
         |
         | 1km (버퍼 내)
         |
         매장 (경로와 수직, 큰 이탈 발생)
```

**해결 방안**:
- ✅ **2차 벡터 근접도 필터링**으로 보완
- 경로 진행 방향을 고려한 근접도 점수 계산

**검증 필요**:
- [ ] 수직 방향 매장 필터링 정확도
- [ ] 벡터 근접도 점수 분포 분석

---

#### 2.2.2 경로 후반부 매장 제외 로직

**한계점**:
- 경로 진행률 80% 이후 매장은 제외
- 하지만 **교통 상황**에 따라 후반부 매장이 더 유리할 수 있음

**예시**:
- 경로 전반부는 정체, 후반부는 원활
- 전반부 매장(+5분), 후반부 매장(+2분)

**해결 방안**:
- ⚠️ 현재는 **단순 진행률 기준** 제외
- 향후 개선: 실시간 교통 정보 반영한 동적 제외 로직

**검증 필요**:
- [ ] 80% 임계값 적절성 검증
- [ ] 교통 정체 상황에서의 정확도

---

### 2.3 API 호출 제한 및 성능

#### 2.3.1 Naver API 일일 무료 쿼터

| API | 무료 쿼터 | 초과 시 비용 | 예상 사용량 |
|-----|----------|------------|-----------|
| **Directions** | 1,000회/일 | 5원/회 | 검색 1회당 41회 |
| **Local Search** | 25,000회/일 | 1원/회 | 시드 시에만 사용 |
| **Reverse Geocoding** | 100,000회/일 | 1원/회 | 검색 1회당 0-2회 |

**위험 시나리오**:
- 하루 **25회 검색**만으로 Directions 쿼터 초과 (25 × 41 = 1,025회)
- MVP 단계에서는 충분하지만, 실제 서비스 시 **빠르게 초과** 가능

**대응 방안**:
1. ✅ **벡터 필터링으로 API 호출 최소화** (50개 → 20개)
2. ⚠️ **캐싱 레이어 도입** (향후):
   - 동일 A→B 경로: 1시간 캐시
   - 매장 좌표: 24시간 캐시
3. 📊 **일일 API 사용량 모니터링**:
   - 80% 도달 시 알림
   - 95% 도달 시 검색 제한 (유료 전환 유도)

**검증 필요**:
- [ ] 하루 검색 가능 횟수 실측
- [ ] 캐싱 효과 분석

---

#### 2.3.2 응답 시간 성능

**목표**:
- 전체 응답 시간 < 3초

**병목 구간**:
1. **Naver Directions API**: 평균 100ms/회 (병렬 40회 = 1-2초)
2. **PostGIS 쿼리**: 평균 100-200ms
3. **네트워크 지연**: 평균 50-100ms

**최악 시나리오**:
- 장거리 경로 (서울→부산): 경로 포인트 2,000개
- 샘플링 후에도 50개 이상
- PostGIS 쿼리 느려짐 (500ms+)

**대응 방안**:
- ✅ **동적 샘플링 간격 조정**:
  ```typescript
  if (routeDistance > 50000) {
    sampleInterval = 2000; // 2km
  }
  ```
- ⚠️ **타임아웃 설정**: 10초 초과 시 에러 반환

**검증 필요**:
- [ ] 장거리 경로 성능 테스트 (서울→부산)
- [ ] PostGIS 인덱스 성능 측정

---

## 3. 예외 케이스 및 폴백 전략

### 3.1 검색 결과 없음

**발생 원인**:
1. 경로 주변 1km 내에 해당 카테고리 매장이 없음
2. 모든 후보가 경로 후반부(80% 이후)에 위치
3. 모든 후보가 이탈 비용 임계값 초과 (5km+)

**폴백 전략**:
```typescript
if (results.length === 0) {
  return {
    success: true,
    data: {
      originalRoute,
      results: [],
      message: '경로 주변에 매장이 없습니다. 검색 조건을 조정해주세요.',
      suggestions: [
        '다른 카테고리를 선택해보세요',
        '출발지 또는 도착지를 변경해보세요',
      ]
    }
  };
}
```

**검증 필요**:
- [ ] 산악/도서 지역 검색 (결과 없음 예상)
- [ ] 빈 결과 UI 표시 확인

---

### 3.2 API 호출 실패

#### 3.2.1 네트워크 타임아웃

**발생 원인**:
- Naver API 서버 과부하
- 사용자 네트워크 불안정

**대응 방안**:
```typescript
// client.ts: Retry 로직 (3회)
async request<T>(config: any, retries = 3): Promise<T> {
  try {
    return await this.client.request(config);
  } catch (error) {
    if (retries > 0 && this.isRetryable(error)) {
      await this.delay(1000); // 1초 대기
      return this.request<T>(config, retries - 1);
    }
    throw error;
  }
}
```

**검증 필요**:
- [ ] 인위적 타임아웃 테스트
- [ ] Retry 로직 동작 확인

---

#### 3.2.2 경로 없음 (404)

**발생 원인**:
- 섬 지역 (백령도, 울릉도 등)
- 접근 제한 구역 (군사 시설 등)
- 일방통행으로 인한 C→B 불가

**대응 방안**:
```typescript
try {
  const route = await getRoute(start, end);
} catch (error) {
  if (error.code === 'NO_ROUTE') {
    // 해당 매장 제외
    return null;
  }
  throw error;
}
```

**검증 필요**:
- [ ] 백령도 → 강화도 검색 (경로 없음 예상)
- [ ] 404 에러 처리 로직 확인

---

### 3.3 데이터베이스 관련 예외

#### 3.3.1 PostGIS 확장 비활성화

**발생 원인**:
- Railway 초기 설정 실패
- 마이그레이션 누락

**증상**:
```sql
ERROR: function st_dwithin(geography, geography, double precision) does not exist
```

**대응 방안**:
```sql
-- 수동 활성화
CREATE EXTENSION IF NOT EXISTS postgis;

-- 확인
\dx
```

**검증 필요**:
- [ ] Railway 배포 후 PostGIS 확인
- [ ] 마이그레이션 스크립트 검증

---

#### 3.3.2 GIST 인덱스 누락

**발생 원인**:
- Prisma 스키마 오류
- 수동 인덱스 생성 필요

**증상**:
- PostGIS 쿼리 성능 저하 (200ms → 2000ms)

**대응 방안**:
```sql
-- 인덱스 생성 확인
SELECT * FROM pg_indexes WHERE tablename = 'Place';

-- 수동 생성 (필요 시)
CREATE INDEX "Place_coordinates_idx" ON "Place" USING GIST (coordinates);
```

**검증 필요**:
- [ ] GIST 인덱스 존재 확인
- [ ] 인덱스 사용 여부 (EXPLAIN ANALYZE)

---

## 4. 사용자 시나리오별 테스트 케이스

### 4.1 정상 시나리오 (Happy Path)

| 테스트 케이스 | 출발지 | 도착지 | 카테고리 | 예상 결과 |
|-------------|-------|-------|---------|----------|
| **도심 단거리** | 서울시청 | 강남역 | 다이소 | 10개 결과, < 3초 |
| **도심 중거리** | 홍대입구역 | 잠실역 | 스타벅스 | 10개 결과, < 3초 |
| **도심 장거리** | 서울역 | 수원역 | CU | 10개 결과, < 3초 |

**검증 포인트**:
- [ ] 응답 시간 < 3초
- [ ] 결과 10개 이상
- [ ] Detour Cost가 거리순 정렬 (finalScore 기준)

---

### 4.2 예외 시나리오 (Edge Cases)

| 테스트 케이스 | 출발지 | 도착지 | 카테고리 | 예상 결과 |
|-------------|-------|-------|---------|----------|
| **결과 없음** | 북한산 입구 | 도봉산 입구 | 다이소 | 0개 결과, 안내 메시지 |
| **장거리** | 서울역 | 부산역 | 스타벅스 | 10개 결과, < 5초 (샘플링 간격 2km) |
| **중앙분리대** | 강남대로 북측 | 강남대로 남측 | 다이소 | 유턴 경로 반영된 결과 |
| **일방통행** | 종로3가역 | 종각역 | CU | 일방통행 고려된 결과 |

**검증 포인트**:
- [ ] 빈 결과 폴백 메시지 확인
- [ ] 장거리 샘플링 간격 동적 조정 (2km)
- [ ] 중앙분리대 유턴 경로 정확도
- [ ] 일방통행 회피 경로 정확도

---

### 4.3 스트레스 테스트

| 테스트 케이스 | 목적 | 예상 결과 |
|-------------|------|----------|
| **동시 검색 10회** | API 병렬 처리 | 각 검색 < 5초 |
| **하루 25회 검색** | API 쿼터 확인 | 1,025회 API 호출 (초과 위험) |
| **대형 건물 매장** | 좌표 정확도 | 출입구 vs 중심 오차 ±10m |

**검증 포인트**:
- [ ] 병렬 요청 처리 성능
- [ ] API 쿼터 초과 알림
- [ ] 좌표 오차 허용 범위

---

## 5. QA 최종 결론 및 권고사항

### 5.1 치명적 위험 (Critical) - 반드시 해결 필요

1. ❌ **API 쿼터 초과 위험**:
   - **현상**: 하루 25회 검색만으로 무료 쿼터 초과
   - **해결**: 캐싱 레이어 도입, API 사용량 모니터링

2. ❌ **장거리 경로 성능 저하**:
   - **현상**: 서울→부산 검색 시 5초 이상 소요 가능
   - **해결**: 동적 샘플링 간격 조정 (이미 구현됨)

---

### 5.2 주요 위험 (High) - 빠른 해결 권장

1. ⚠️ **시간 정확도 ±10% 오차**:
   - **현상**: 신호대기, 주차 시간 미포함
   - **해결**: UI 안내 문구 명확히 표시 (이미 계획됨)

2. ⚠️ **매장 정보 최신성**:
   - **현상**: 폐업, 임시 휴업 정보 지연
   - **해결**: 주기적 매장 데이터 갱신 (주 1회)

---

### 5.3 경미한 위험 (Medium) - 추후 개선

1. 📝 **경로 후반부 매장 제외 로직**:
   - **현상**: 80% 이후 매장 무조건 제외
   - **개선**: 실시간 교통 정보 반영한 동적 로직

2. 📝 **수직 방향 매장 과다 포함**:
   - **현상**: 원형 버퍼 검색으로 수직 방향 매장 포함
   - **개선**: 벡터 필터링으로 이미 보완됨, 추가 개선 여지 있음

---

### 5.4 QA 승인 여부

**✅ 조건부 승인 (Conditionally Approved)**

**승인 조건**:
1. ✅ API 사용량 모니터링 대시보드 구현
2. ✅ UI 안내 문구 명확히 표시
3. ✅ Retry 로직 및 에러 핸들링 완비
4. ✅ 주요 예외 케이스 테스트 완료

**MVP 단계에서는 현재 기획안으로 충분히 구현 가능하며, 위 4가지 조건을 충족하면 프로덕션 배포 가능합니다.**

---

## 6. 테스트 체크리스트

### Phase 1-2: 기초 설정 테스트
- [ ] PostGIS 확장 활성화 확인 (`\dx`)
- [ ] GIST 인덱스 생성 확인
- [ ] Prisma 마이그레이션 성공
- [ ] 타입 정의 TypeScript 컴파일 에러 0개

### Phase 3: API 연동 테스트
- [ ] Naver Directions API 테스트 (서울시청→강남역)
- [ ] Local Search API 테스트 (다이소 검색)
- [ ] Retry 로직 동작 확인 (인위적 타임아웃)
- [ ] 404 에러 처리 (백령도→강화도)

### Phase 4: 핵심 알고리즘 테스트
- [ ] Haversine 거리 계산 정확도 (±5%)
- [ ] Polyline 샘플링 500m 간격 확인
- [ ] PostGIS ST_DWithin 성능 < 200ms
- [ ] 벡터 근접도 점수 0-100 범위
- [ ] Detour Cost 수동 검증 (샘플 3개)

### Phase 5: API Routes 테스트
- [ ] `POST /api/search` 정상 응답 (200 OK)
- [ ] Zod 스키마 검증 (잘못된 입력 → 400)
- [ ] 빈 결과 폴백 메시지
- [ ] API 응답 시간 < 3초

### Phase 6: 프론트엔드 테스트
- [ ] Naver Maps SDK 지도 표시
- [ ] 출발/도착 마커 표시
- [ ] 검색 결과 리스트 렌더링
- [ ] 결과 클릭 시 경유 경로 표시

### Phase 7: 예외 케이스 테스트
- [ ] 중앙분리대 (강남대로)
- [ ] 일방통행 (종로구 골목)
- [ ] 고가도로 진입로
- [ ] API 타임아웃 시나리오
- [ ] 장거리 경로 (서울→부산)

---

## 7. 참고 자료

### Naver API 에러 코드
- [Directions API 에러 코드](https://api.ncloud-docs.com/docs/ai-naver-mapsdirections-driving#%EC%97%90%EB%9F%AC-%EC%BD%94%EB%93%9C)
- [Local Search API 에러 코드](https://api.ncloud-docs.com/docs/ai-naver-mapslocalsearch#%EC%97%90%EB%9F%AC-%EC%BD%94%EB%93%9C)

### PostGIS 성능 최적화
- [GIST Index Performance](https://postgis.net/workshops/postgis-intro/indexing.html)
- [ST_DWithin vs ST_Distance](https://postgis.net/docs/ST_DWithin.html)

---

**QA 승인 서명**: [QA] Tester
**검토 완료일**: 2026-01-29
